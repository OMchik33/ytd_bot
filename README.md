# ОБНОВЛЕНИЯ:
- **05.02.2026** - Правка кода, нод снова скачивает! Нужно nodejs и yt-dlp-ejs
- **27.01.2026** - Правки кода, бот снова скачивает
- **24.10.2025** - обновлен UA, убрано ограничение "только MP4". 
- **06.10.2025** - глобальное обновление кода, улучшение работы, оптимизация
- **04.06.2025** - добавил скачивание MP3 и перенес переменные в .env файл
- **10.05.2025** - ~~добавил bot2.sh скрипт с возможностями обновления компонентов бота и возможность установить скрипт бота на сервер "с нуля" с вариантами на уже рабочий nginx сервер с добавленными доменами, и вариант когда домены не используются. || Скрипт в бета версии. Все работает кроме автоустановки бота на сервер~~
- **14.04.2025** - Переделал логику работы. // Объединил кнопки для скачивания видео, теперь бот сам определяет есть ли качество у видео, и предлагает выбрать. Если нет - скачать в максимальном качестве. // Возможность скачать обложку. // Исправил ошибки. Теперь бот скачивает преимущественно в MP4 формате
- **17.03.2025** - добавил кнопку "Инструкция"
- **05.03.2025** - добавлена 3 кнопка, теперь 1 - скачать видео в лучшем качестве (нужна для скачивания шортсов или видео с различных видеосервисов), 2 - скачать с Ют... с выбором качества для скачивания, 3 - загрузить куки файл
- **03.03.2025** - реализован выбор качества видео для скачивания

# Список файлов
| Файл  | Описание  |
| ------------- | --------------------------------------- |
| ytd_bot.py  | Основной файл бота  |
| .env  | Переменные и настройки бота в этом файле  |

# Возможности бота
- Скачивание видео с видеосервисов (поддерживаемых программой yt-dlp)
- Выбор качества видео от 480p и выше
- Можно скачивать сразу, можно после загрузки куки файла (если видеосервис без него блокирует скачивание). Подробнее про куки смотри FAQ
- Таймер на скачивание 30 минут, после этого Crontab удалит старые файлы.
- Файлы сохраняются с уникальным случайным именем для предотвращения ошибок, при скачивании возвращается оригинальное название, за вычетом запрещенных в названии файла символов
- Доступ к боту как через жестко прописанные Telegram ID, так и по уникальной ссылке с секретным кодом. База данных не используется, поэтому бот помнит тех, кто зашел по ссылке, пока работает. После перезапуска потребуется снова заходить по ссылке.
- Пример ссылки для входа в бот: https://t.me/mytg12345first_bot?start=secretcode12345

# Установка
**Условия для установки бота:**
1) Все делается из под пользователя root (инструкция для новичков, более опытные без проблем сделают из-под другого пользователя с помощью sudo)
2) К серверу прикреплен домен (платный или бесплатный)
3) Установлен nginx `apt install nginx`
4) Установлены SSL сертификаты для домена, прикрепленного к серверу, и прописаны в конфигурацию сайта nginx. Если сертификатов нет, используйте обычный незащищенный http
### Создаем нужные папки на сервере
- `mkdir /root/ytd` - корневая папка бота
- `mkdir /root/ytd/cookies` - папка для куки
- `mkdir /download` папка для скачивания файлов
### Скачиваем скрипт на свой сервер
Скачиваем `ytd_bot.py` в папку `/root/ytd`
# Настройка бота
1. **Открываем на редактирование .env файл рядом с ботом и правим конфигурацию** `nano /root/ytd/.env`

(Пример этого файла находится в данном репозитории)

| Переменная  | Значение  |
| ------------- | ---------------------------------- |
| BOT_TOKEN  | токен телеграм бота, делаем бота через @BotFather, инструкции есть в интернете  |
| ALLOWED_USERS  | ваш телеграм ID.  |
| DOWNLOAD_BASE_URL  | "https://ВАШДОМЕН.ru/files" - Путь для скачивания. Можно оставить как есть, можно поменять. Этот же путь, только без домена, мы будем указывать в настройках nginx.  |

2. **Настраиваем nginx** (он уже должен быть установлен, работать на 443 порту, получены SSL сертификаты. Если порт другой - требуется перенастройка бота)

Открываем редактирование сайта в nginx

`nano /etc/nginx/sites-available/default `
> default - настроки сайта по умолчанию. Если у вас другое название файла конфигурации, настраивайте его.
Добавляем в код секцию для скачивания перед закрывающей скобкой блока server {}

```bash
    # Локация для скачивания файлов
    location /files/ {
        alias /download/;  # Указываем путь к папке на сервере
        autoindex off;  # Отключаем отображение списка файлов

    # Проверяем, существует ли файл
    if (-f $request_filename) {
        # Если файл существует, отдаем его с оригинальным именем
        add_header Content-Disposition "attachment; filename=$arg_filename";
    }
}
```
**ВАЖНО:** название локации - files должно быть одинаковым как в настройках nginx, так и в переменной DOWNLOAD_BASE_URL после домена/

3. **Проверяем конфиг nginx и перезапускаем**
`nginx -t`
`systemctl restart nginx`

4. **Настраиваем виртуальное окружение Python.**
Запускаем команды ниже в терминале

|  Команда | Описание  |
| ------------ | ------------ |
| `python3 -m venv mybotenv`  | Создаем виртуальную среду mybotenv |
| `source mybotenv/bin/activate` | Активируем виртуальную среду |
| `pip install aiogram yt-dlp[default] python-dotenv` | Устанавливаем необходимое ПО |
| `deactivate` | Выходим из виртуальной среды |

5. **Добавляем в Crontab автоудаление скачанных более чем 30 минут назад файлов**

`crontab -e` вводим эту команду в консоли для открытия списка задач Crontab

Добавляем туда код:
```bash
*/5 * * * * find /download -type f -mmin +30 -delete
```
Проверяем: `crontab -l`
Применяем изменения в планировщике: `systemctl restart cron`

6. **Устанавливаем ffmpeg**

```
apt install ffmpeg -y
```


7. **Создаем сервис, добавляем в автозагрузку, запускаем бота.**

- Вводим в консоли: `nano /etc/systemd/system/ytd_bot.service`

```bash
[Unit]
Description=Telegram Bot Service
After=network.target

[Service]
User=root
WorkingDirectory=/root/ytd
ExecStart=/root/mybotenv/bin/python3 /root/ytd/ytd_bot.py
Restart=always
RestartSec=5
Environment="PYTHONUNBUFFERED=1"

[Install]
WantedBy=multi-user.target
```
- Включаем автозагрузку: `systemctl enable ytd_bot.service`
- Запускаем бот: `systemctl start ytd_bot.service`

## Важно:
Если бот вообще перестал скачивать видео, активируйте виртуальную среду и обновите yt-dlp[default]

```
source mybotenv/bin/activate
pip install --upgrade yt-dlp[default]
deactivate
```

# FAQ
1. Для работы бота требуется установить [плагин](https://chromewebstore.google.com/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc "плагин") в ваш браузер. (п.с.: без куки тоже может скачивать, если видеосервис позволит)
2. Переходим на сайт, откуда будем скачивать видео, и с помощью плагина сохраняем куки файл в формате Netscape. Крайне желательно иметь учетную запись на этом сайте и быть в ней авторизованным. Далее запускаем бот. Загружаем куки файл в бот. Скачиваем видео...
3. Для другого сайта/сервиса, потребуется соответствующий этому сайту куки файл.
4. Для каждого пользователя бот сохраняет свой собственный куки файл с уникальным названием.

При тестировании бота использовались следующие версии ПО:

| Программа  | Версия  |
| ------------ | ------------ |
| Python | 3.12.3 |
| aiogram  | 3.22.0 |
|  yt-dlp  | 2025.9.26 |
|  ffmpeg  | 6.1.1-3ubuntu5 |
|  python-dotenv  | 1.1.1 |
|  nodejs  | хз |
|  yt-dlp-ejs  | хз |


# ОТВЕТСТВЕННОСТЬ

1. Бот подходит для частного использования и исключительно в ознакомительных целях!
2. При работе с ботом требуется соблюдать законодательство страны проживания и не скачивать видео, запрещенные к скачиванию в стране проживания и в стране, где арендован VPS сервер!
3. Код бота размещен исключительно в образовательных целях, не предназначен для коммерческого использования.
4. Вся ответственность за использование кода бота на своем сервере, а также за соблюдение законодательства вашей страны (в том числе соблюдение правил скачивания видео) лежит исключительно на вас!
