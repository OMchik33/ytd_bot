# ytd_bot
- Функционал бота основан на программе yt-dlp https://github.com/yt-dlp/yt-dlp
- Установка тестировалась на Ubuntu 24.
- Бот позволяет скачивать видео с различных видеосервисов, используя куки файл, загружаемый пользователем. Для каждого видеосервиса требуется свой куки файл. Куки файлы требуются для обхода блокировки видеосервисами IP адресов хостингов популярных VPS.
- Скачивание происходит с участием вебсервера nginx.

# Список файлов
| Файл  | Описание  |
| ------------- | --------------------------------------- |
| ytd_bot.py  | Основной файл бота  |
| bot.sh  | Скрипт для управления службой бота, используется опционально (по желанию)  |
# Установка
**Условия для установки бота:**
1) Все делается из под пользователя root.
2) К серверу прикреплен домен (платный или бесплатный)
3) Установлен и настроен nginx (в боте по умолчанию настроено на стандартный 443 порт)
4) Установлены SSL сертификаты для домена, прикрепленного к серверу.
### Создаем нужные папки на сервере
- `/root/ytd` - корневая папка бота
- `/root/ytd/cookies` - папка для куки
- `/download` папка для скачивания файлов
### Скачиваем скрипт на свой сервер
Скачиваем `ytd_bot.py` в папку `/root/ytd`
# Настройка бота
1. **Открываем на редактирование наш файл бота и правим конфигурацию** `nano /root/ytd/ytd_bot.py`

| Переменная  | Значение  |
| ------------- | ---------------------------------- |
| BOT_TOKEN  | токен телеграм бота, делаем бота через BotFather, инструкции есть в интернете  |
| ALLOWED_USERS  | ваш телеграм ID. Как его получить, инструкции тоже есть  |
| DOWNLOAD_BASE_URL  | "https://ВАШДОМЕН.ru/1234567yourrandom" - здесь пишите свой домен и уникальный рандомный путь для скачивания. Сделайте его длинным, символов в 30 (рандомные буквы и цифры). Этот же путь, только без домена, мы будем указывать в настройках nginx.  |

2. **Настраиваем nginx** (он уже долежн быть установлен, работать на 443 порту, получены SSL сертификаты. Если порт другой - требуется перенастройка бота)

Открываем редактирование сайта в nginx

`nano /etc/nginx/sites-available/default `
> default - настроки сайта по умолчанию. Если у вас другое название файла конфигурации, настраивайте его.
Добавляем в код секцию для скачивания перед закрывающей скобкой блока server {}

```bash
    # Локация для скачивания файлов
    location /1234567yourrandom/ {
        alias /download/;  # Указываем путь к папке на сервере
        autoindex on;  # Включаем отображение списка файлов
        autoindex_exact_size off;  # Показываем размер файлов в удобном формате
        autoindex_localtime on;  # Показываем время файлов по локальному времени
        charset utf-8;  # Устанавливаем кодировку UTF-8
        # Если файл существует, отдаем его с оригинальным именем
        if (-f $request_filename) {
            add_header Content-Disposition "attachment; filename=$arg_filename";
        }
}
```

3. **Проверяем конфиг nginx и перезапускаем**
`nginx -t`
`systemctl restart nginx`

4. **Настраиваем виртуальное окружение Python.**
Запускаем команды ниже в терминале

|  Команда | Описание  |
| ------------ | ------------ |
| `python3 -m venv mybotenv`  | Создаем виртуальную среду mybotenv |
| `source mybotenv/bin/activate` | Активируем виртуальную среду |
| `pip install aiogram yt-dlp` | Устанавливаем необходимое ПО |
| `deactivate` | Выходим из виртуальной среды |

5. **Добавляем в Crontab автоудаление скачанных более чем 60 минут назад файлов**

`crontab -e` вводим эту команду в консоли для открытия списка задач Crontab

Добавляем туда код:
```bash
0 * * * * find /download -type f -mmin +60 -exec rm -f {} \;
```
Проверяем: `crontab -l`
Применяем изменения в планировщике: `systemctl restart cron`

6. **Создаем сервис, добавляем в автозагрузку, запускаем бота.**

- Вводим в консоли: `nano /etc/systemd/system/ytd_bot.service`

```bash
[Unit]
Description=Telegram Bot Service
After=network.target

[Service]
User=root
WorkingDirectory=/root/ytd
ExecStart=/root/mybotenv/bin/python3 /root/ytd/ytd_bot.py
Restart=always
RestartSec=5
Environment="PYTHONUNBUFFERED=1"

[Install]
WantedBy=multi-user.target
```
- Включаем автозагрузку: `systemctl enable ytd_bot.service`
- Запускаем бот: `systemctl start ytd_bot.service`

# FAQ
1. Для работы бота требуется установить [плагин](https://chromewebstore.google.com/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc "плагин") в ваш браузер.
2. Переходим на наш сайт, откуда будем скачивать видео, и с помощью плагина сохраняем куки файл в формате Netscape. Крайне желательно иметь учетную запись на этом сайте и быть в ней авторизованным. Далее запускаем бот. Загружаем куки файл в бот. Скачиваем видео...
3. Для другого сайта/сервиса, потребуется соответствующий этому сайту куки файл.
4. Для каждого пользователя бот сохраняет свой собственный куки файл с уникальным названием.

При тестировании бота использовались следующие версии ПО:

| Программа  | Версия  |
| ------------ | ------------ |
| Python | 3.12.3 |
| aiogram  | 3.18.0 |
|  yt-dlp  | 2025.2.19 |

# ОТВЕТСТВЕННОСТЬ

1. Бот подходит для частного использования и исключительно в ознакомительных целях!
2. При работе с ботом требуется соблюдать законодательство страны проживания и не скачивать видео, запрещенные к скачиванию в стране проживания и в стране, где арендован VPS сервер!
3. Код бота размещен исключительно в образовательных целях, не предназначен для коммерческого использования.
4. Вся ответственность за использование кода бота на своем сервере, а также за соблюдение законодательства вашей страны (в том числе соблюдение правил скачивания видео) лежит исключительно на вас!
